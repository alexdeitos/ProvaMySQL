{% extends 'base.html' %}

{% load static %}

{% block title %}Perguntas e Respostas{% endblock %}

{% block content %}
<div class="container">
  <h1 class="row col-10 mx-auto titulo-prova">{{ prova.nome }}</h1>
  <form method="post" id="formulario-respostas" class="row col-11 mx-auto prova">
    {% csrf_token %}
    {% for pergunta in perguntas %}
    {% with num_palavras=pergunta.texto_formatado|wordcount %}
    <div class="pergunta {% if num_palavras > 30 %}fonte-pequena{% endif %}" id="pergunta-{{ pergunta.id }}">
      <h2>{{ pergunta.texto_formatado|safe }}</h2>
    </div>
    {% endwith %}

    {% if pergunta.imagem %}
    <img src="{{ pergunta.imagem.url }}" alt="Imagem da pergunta">
    {% endif %}

    {% for resposta in pergunta.resposta_set.all %}
    <div class="resposta" id="resposta-{{ pergunta.id }}-{{ resposta.id }}">
      <label>
        <input type="checkbox" name="{{ pergunta.id }}" value="{{ resposta.id }}"
          {% if resposta.correta %}data-correta="true" {% endif %}>
        <span style="font-size:25px;line-height: 1.2;" id="resposta-label-{{ pergunta.id }}-{{ resposta.id }}"
          class="resposta-label {% if resposta.correta %}correta{% endif %}">{{ resposta.texto_formatado|safe }}</span>
      </label>
    </div>
    {% endfor %}
    <hr class="break-line">
    {% endfor %}
    <button class="conf-prova btn btn-success align-self-center mr-3 col-8 mx-auto" type="button"
      id="enviar-respostas">Enviar Respostas</button>
    <button class="conf-prova btn btn-success align-self-center mr-3 col-8 mx-auto" type="button"
      id="limpar-respostas">Limpar Respostas</button>
    <button class="conf-prova btn btn-success align-self-center mr-3 col-8 mx-auto" type="button" 
      id="marcar-corretas">Marcar Corretas</button>
  </form>

  <!-- Incorporar o código JavaScript diretamente -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let perguntasCorretas = 0;
      let perguntasIncorretas = 0;
  
      const enviarRespostasBtn = document.getElementById('enviar-respostas');
      enviarRespostasBtn.addEventListener('click', validarRespostas);
  
      const limparRespostasBtn = document.getElementById('limpar-respostas');
      limparRespostasBtn.addEventListener('click', limparRespostas);
      
      const marcarCorretasBtn = document.getElementById('marcar-corretas');
      marcarCorretasBtn.addEventListener('click', marcarRespostasCorretas);

      function marcarRespostasCorretas() {
        const respostas = document.querySelectorAll('input[type="checkbox"]');
        respostas.forEach(resposta => {
          const perguntaId = resposta.name;
          const respostaLabel = document.getElementById(`resposta-label-${perguntaId}-${resposta.value}`);
          if (resposta.getAttribute('data-correta')) {
            resposta.checked = true;
            respostaLabel.style.color = 'blue';
          } else {
            resposta.checked = false;
            respostaLabel.style.color = '';
          }
        });
      }

      function validarRespostas() {
        const respostasMarcadas = document.querySelectorAll('input[type="checkbox"]:checked');
  
        respostasMarcadas.forEach(resposta => {
          const perguntaId = resposta.name;
          const respostaLabel = document.getElementById(`resposta-label-${perguntaId}-${resposta.value}`);
  
          if (resposta.getAttribute('data-correta')) {
            respostaLabel.style.color = 'blue'; // Marca a resposta como correta (azul)
            perguntasCorretas++;
          } else {
            respostaLabel.style.color = 'red'; // Marca a resposta como incorreta (vermelha)
            perguntasIncorretas++;
          }
        });
  
        exibirAlerta();
      }
  
      function limparRespostas() {
        perguntasCorretas = 0;
        perguntasIncorretas = 0;
  
        const respostas = document.querySelectorAll('input[type="checkbox"]');
        respostas.forEach(resposta => {
          resposta.checked = false;
          const perguntaId = resposta.name;
          const respostaLabel = document.getElementById(`resposta-label-${perguntaId}-${resposta.value}`);
          respostaLabel.style.color = '';
        });
      }
  
      function exibirAlerta() {
        const totalPerguntas = {{ perguntas | length }};
        const perguntasRespondidas = perguntasCorretas + perguntasIncorretas;
        const perguntasNaoRespondidas = totalPerguntas - perguntasRespondidas;
  
        let mensagem = `Você respondeu corretamente ${perguntasCorretas} pergunta(s).\n`;
        mensagem += `Você respondeu incorretamente ${perguntasIncorretas} pergunta(s).\n`;
        mensagem += `Você não respondeu ${perguntasNaoRespondidas} pergunta(s).`;
  
        alert(mensagem);
      }
    });
  </script>
</div>
{% endblock %}